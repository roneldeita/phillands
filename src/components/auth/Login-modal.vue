<template>
  <div>
    <el-dialog
      title=""
      :visible.sync="dialogVisible"
      size="tiny"
      @close="dialogClose"
      class="login-modal"
      >
      <el-row>
        <el-col :span="24" style="padding:30px; background:#f0f0f0">
          <img src="../../assets/PL_Logo_250px.png" style="width:60%">
        </el-col>
        <el-col :offset="2" :span="20" class="">

          <el-tabs v-show="!forgetPassword" v-model="activeAuthTab">
            <el-tab-pane label="Login" name="login">
              <div class="" style="padding:5px 0 10px 0">
                <el-button type="default" @click="authenticate('google')" style="width:100%"><span class="fa fa-google"></span> Login with google</el-button>
              </div>
              <div class="" style="padding:5px 0 10px 0">
                <el-button type="info" @click="authenticate('facebook')" style="width:100%"><span class="fa fa-facebook-official"></span> Login with facebook</el-button>
              </div>
              <p>or</p>
              <el-form :model="loginForm" :rules="loginRules" ref="loginForm" label-width="0">
                <el-form-item label="" prop="email">
                  <el-input v-model="loginForm.email" placeholder="Email"></el-input>
                </el-form-item>
                <el-form-item label="" prop="password" style="margin-top:25px">
                  <el-input type="password" v-model="loginForm.password" placeholder="Password"></el-input>
                </el-form-item>
                <el-form-item class="text-left" style="margin-top:25px">
                  <el-button type="primary" @click="handleLogin('loginForm')">Login</el-button>
                </el-form-item>
                <el-button type="text" @click="forgetPassword = true"> Forgot your password?</el-button>
              </el-form>
            </el-tab-pane>

            <el-tab-pane label="Register" name="register">
              <el-form :model="registerForm" :rules="registerRules" ref="registerForm" label-width="0">
                <el-form-item label="" prop="first_name" style="margin-bottom:22px">
                  <el-input v-model="registerForm.first_name" placeholder="Your first name"></el-input>
                </el-form-item>
                <el-form-item label="" prop="last_name" style="margin-bottom:22px">
                  <el-input v-model="registerForm.last_name" placeholder="Your last name"></el-input>
                </el-form-item>
                <el-form-item label="" prop="contact" style="margin-bottom:22px">
                  <el-input type="number" v-model="registerForm.contact" placeholder="Your Contact Number"></el-input>
                </el-form-item>
                <el-form-item label="" prop="email" style="margin-bottom:22px">
                  <el-input v-model="registerForm.email" placeholder="Email Address"></el-input>
                </el-form-item>
                <el-form-item label="" prop="password" style="margin-bottom:25px">
                  <el-input type="password" v-model="registerForm.password" placeholder="Password"></el-input>
                </el-form-item>
                <el-form-item class="text-left">
                  <el-button type="primary" @click="handleRegistration('registerForm')">Register</el-button>
                </el-form-item>
              </el-form>
            </el-tab-pane>

          </el-tabs>

          <el-tabs v-show="forgetPassword">
            <el-tab-pane label="Reset Password">
              <p class="text-left">Enter the email address associated with your account, and weâ€™ll email you a link to reset your password.</p>
              <el-form :model="resetPasswordForm" :rules="resetPasswordRules" ref="resetPasswordForm" label-width="0">
                <el-form-item label="" prop="email" style="margin-bottom:22px">
                  <el-input v-model="resetPasswordForm.email" placeholder="Email Address"></el-input>
                </el-form-item>
                <el-form-item>
                  <el-button class="pull-left" type="text" @click="forgetPassword = false"><span class="el-icon-arrow-left"></span> Back to Login</el-button>
                  <el-button class="pull-right" type="primary">Send Resend Link</el-button>
                </el-form-item>
              </el-form>
            </el-tab-pane>
          </el-tabs>

        </el-col>
      </el-row>
      <br>
    </el-dialog>
  </div>
</template>

<script>
import axios from 'axios';
import { baseUrl } from '../../assets/utils/properties-api.js';
import { isLoggedIn, login, register } from '../../assets/utils/auth.js';

export default {
  name:'login-modal',
  props:['loginmodal'],
  data(){
    return{
      dialogVisible: this.loginmodal,
      activeAuthTab:'login',
      forgetPassword:false,
      loginForm:{
        email:'',
        password:''
      },
      registerForm:{
        first_name:'',
        last_name:'',
        contact:'',
        email:'',
        password:''
      },
      resetPasswordForm:{
        email:''
      },
      loginRules:{
        email: [
          { required: true, message: 'Please input email', trigger: 'blur' },
          { type: 'email', message: 'Incorrect email format', trigger: 'blur' }
        ],
        password: [
          { required: true, message: 'Please input password', trigger: 'blur' }
        ]
      },
      registerRules:{
        first_name: [
          { required: true, message: 'Please input your first name', trigger: 'blur' },
          { type: 'string', message: 'Must be letters', trigger: 'blur' }
        ],
        last_name:[
          { required: true, message: 'Please input your first name', trigger: 'blur' },
          { type: 'string', message: 'Must be letters', trigger: 'blur' }
        ],
        contact:[
          { required: true, message: 'Please input your contact number', trigger: 'blur' }
        ],
        email: [
          { required: true, message: 'Please input email', trigger: 'blur' },
          { type: 'email', message: 'Incorrect email format', trigger: 'blur' }
        ],
        password: [
          { required: true, message: 'Please input password', trigger: 'blur' }
        ]
      },
      resetPasswordRules:{}
    }
  },
  methods:{
    dialogClose:function(){
      this.$emit('loginmodalclose', this.dialogVisible)
    },
    authenticate: function (provider) {
      this.$auth.authenticate(provider).then(function (authResponse) {
        console.log(authResponse);
        // Execute application logic after successful social authentication
      })
    },
    handleLogin:function(formName){
      this.$refs[formName].validate((valid) => {

        if(valid){

          this.doLogin(this.loginForm);

        }else{
          //console.log(valid)
        }

      });
    },
    handleRegistration:function(formName){

      this.$refs[formName].validate((valid) => {

        if(valid){
          const self = this;

          axios.post(baseUrl()+'/register', this.registerForm)
          .then(function(response) {
            self.doLogin({email:self.registerForm.email, password:self.registerForm.password});
          })
          .catch(function(error) {
            self.$message.error(error.response.data.message)
          });

        }else{
          //
        }

      });

    },
    doLogin:function(formData){
      const self = this;

      axios.post(baseUrl()+'/login',formData)
      .then(function(response) {
        localStorage.setItem('access_token', response.data.token);
        localStorage.setItem('user', JSON.stringify(response.data.user));

        location.reload();

      })
      .catch(function(error) {
        self.$message.error('Email or Password is incorrect')
      });
    },
    resetPasswordWasClick:function(){
      this.$emit('resetpassword');
    },
  },
  watch:{
    loginmodal:function(e){
      this.dialogVisible = this.loginmodal
    }
  },
  mounted(){
    //this.dialogVisible = this.modal
  }
}
</script>

<style>
  @media (max-width: 575px) {
    .el-dialog--tiny{
      top: 0% !important;
      bottom: 0% !important;
      height: 100% !important;
      width: 100% !important;
    }
  }
</style>
